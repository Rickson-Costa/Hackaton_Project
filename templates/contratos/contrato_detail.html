{% extends 'base/base.html' %}

{% block title %}Contrato {{ contrato.num_contrato }}{% endblock %}
{% block page_title %}Detalhes do Contrato{% endblock %}

{% block page_actions %}
<a href="{% url 'contratos:contrato_list' %}" class="btn btn-secondary">
    <i class="fas fa-arrow-left me-1"></i> Voltar para a Lista
</a>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">Informações do Contrato</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Número:</strong> {{ contrato.num_contrato }}</p>
                        <p><strong>Contratado:</strong> {{ contrato.contratado }}</p>
                        <p><strong>CPF/CNPJ:</strong> {{ contrato.cpf_cnpj }}</p>
                        <p><strong>Tipo:</strong> {{ contrato.get_tipo_pessoa_display }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Valor Total:</strong> R$ {{ contrato.valor|floatformat:2 }}</p>
                        <p><strong>Situação:</strong> <span class="badge bg-success">{{ contrato.get_situacao_display }}</span></p>
                        <p><strong>Vigência:</strong> {{ contrato.data_inicio|date:"d/m/Y" }} a {{ contrato.data_fim|date:"d/m/Y" }}</p>
                        <p><strong>Parcelas:</strong> {{ contrato.parcelas }}x</p>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-12">
                        <p><strong>Descrição:</strong></p>
                        <p class="text-muted">{{ contrato.descricao|default:"Sem descrição" }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Resumo Financeiro</h6>
            </div>
            <div class="card-body">
                <p><strong>Valor Total:</strong><br>R$ {{ contrato.valor|floatformat:2 }}</p>
                <p><strong>Valor Pago:</strong><br>R$ 0,00</p>
                <p><strong>Valor Pendente:</strong><br>R$ {{ contrato.valor|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Parcelas do Contrato</h5>
        <a href="{% url 'contratos:itemcontrato-create' contrato.pk %}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i> Adicionar Parcela
        </a>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Parcela</th>
                        <th>Valor</th>
                        <th>Vencimento</th>
                        <th>Situação</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in contrato.itens.all %}
                    <tr>
                        <td>{{ forloop.counter }}ª Parcela</td>
                        <td>R$ {{ item.valor_parcela|floatformat:2 }}</td>
                        <td>{{ item.data_vencimento|date:"d/m/Y" }}</td>
                        <td>
                            {% if item.situacao == '1' %}
                                <span class="badge bg-warning">Pendente</span>
                            {% elif item.situacao == '2' %}
                                <span class="badge bg-info">Processando</span>
                            {% elif item.situacao == '3' %}
                                <span class="badge bg-success">Pago</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ item.get_situacao_display }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.situacao == '1' %}
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" data-bs-target="#pagamentoModal"
                                        data-parcela-pk="{{ item.pk }}"
                                        data-parcela-num="{{ forloop.counter }}"
                                        data-valor-pendente="{{ item.valor_parcela }}">
                                    <i class="fas fa-money-bill me-1"></i> Pagar
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center text-muted">Nenhuma parcela cadastrada</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="pagamentoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registrar Pagamento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="pagamentoForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <p>Registrar pagamento da <strong><span id="modalParcelaNum"></span></strong></p>
                    <p>Valor pendente: <strong><span id="modalValorPendente"></span></strong></p>
                    
                    <div class="mb-3">
                        <label for="valor_pago" class="form-label">Valor Pago (R$)</label>
                        <input type="number" class="form-control" id="valor_pago" name="valor_pago" step="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="data_pagamento" class="form-label">Data do Pagamento</label>
                        <input type="date" class="form-control" id="data_pagamento" name="data_pagamento" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoes" name="observacoes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const pagamentoModal = document.getElementById('pagamentoModal');
    pagamentoModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        const parcelaPk = button.getAttribute('data-parcela-pk');
        const parcelaNum = button.getAttribute('data-parcela-num');
        const valorPendente = button.getAttribute('data-valor-pendente');

        const form = pagamentoModal.querySelector('#pagamentoForm');
        form.action = `/contratos/parcelas/${parcelaPk}/registrar-pagamento/`;

        pagamentoModal.querySelector('#modalParcelaNum').textContent = parcelaNum + 'ª Parcela';
        pagamentoModal.querySelector('#modalValorPendente').textContent = `R$ ${valorPendente}`;
        pagamentoModal.querySelector('#valor_pago').value = valorPendente;
        
        // Data atual como padrão
        const hoje = new Date().toISOString().split('T')[0];
        pagamentoModal.querySelector('#data_pagamento').value = hoje;
    });
});
</script>
{% endblock %}